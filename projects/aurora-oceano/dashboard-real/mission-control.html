<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control - Aurora Oceano</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0c1929 0%, #1a365d 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .glass-light { background: rgba(255,255,255,0.06); }
        .gradient-blue { background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); }
        .gradient-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .gradient-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .gradient-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .gradient-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
        .pulse-dot { animation: pulse 2s infinite; }
        .pulse-urgent { animation: pulse-urgent 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        @keyframes pulse-urgent { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
        .badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; font-weight: 600; text-transform: uppercase; }
        .notification-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .btn-approve { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-approve:hover { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .btn-reject { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .btn-reject:hover { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .btn-counter { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .btn-counter:hover { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); }
        .tab-active { background: rgba(255,255,255,0.1); border-bottom: 2px solid #0ea5e9; }
        input[type="number"], input[type="text"], select { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        input[type="number"]:focus, input[type="text"]:focus, select:focus { outline: none; border-color: #0ea5e9; }
        .loading { opacity: 0.5; pointer-events: none; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-white p-4 lg:p-6">
    <!-- Header -->
    <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 gradient-purple rounded-xl flex items-center justify-center text-2xl">üéõÔ∏è</div>
            <div>
                <h1 class="text-2xl lg:text-3xl font-bold">Mission Control</h1>
                <p class="text-slate-400 text-sm">Centro de Aprova√ß√µes & Alertas - Auroroceano</p>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-3">
            <div class="glass rounded-lg px-3 py-2 text-sm flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 pulse-dot"></span>
                <span class="text-green-400 font-medium">Dados Moloni Live</span>
            </div>
            <a href="/index.html" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2">
                üöö Painel Operacional
            </a>
            <button onclick="refreshAllData()" class="glass hover:bg-white/10 rounded-lg px-4 py-2 text-sm font-medium transition-all flex items-center gap-2">
                üîÑ Actualizar
            </button>
        </div>
    </header>

    <!-- Tabs -->
    <div class="flex gap-1 mb-6 glass rounded-xl p-1 w-fit">
        <button onclick="showTab('aprovacoes')" id="tab-aprovacoes" class="px-4 py-2 rounded-lg text-sm font-medium transition-all tab-active">
            üîî Aprova√ß√µes <span class="badge bg-orange-500/30 text-orange-400 ml-1" id="badge-pendentes">0</span>
        </button>
        <button onclick="showTab('dividas')" id="tab-dividas" class="px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-white/5">
            ‚ö†Ô∏è Alertas D√≠vida <span class="badge bg-red-500/30 text-red-400 ml-1" id="badge-dividas">0</span>
        </button>
        <button onclick="showTab('historico')" id="tab-historico" class="px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-white/5">
            üìä Hist√≥rico Pre√ßos
        </button>
        <button onclick="showTab('regras')" id="tab-regras" class="px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-white/5">
            üìã Regras
        </button>
    </div>

    <!-- Stats R√°pidos - DADOS REAIS -->
    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
        <div class="glass rounded-xl p-4 card-hover">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 gradient-orange rounded-lg flex items-center justify-center">‚è≥</div>
                <div>
                    <p class="text-2xl font-bold" id="kpi-pendentes">-</p>
                    <p class="text-slate-400 text-xs">Pendentes</p>
                </div>
            </div>
        </div>
        <div class="glass rounded-xl p-4 card-hover">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 gradient-green rounded-lg flex items-center justify-center">‚úÖ</div>
                <div>
                    <p class="text-2xl font-bold" id="kpi-aprovados-hoje">-</p>
                    <p class="text-slate-400 text-xs">Facturas Hoje</p>
                </div>
            </div>
        </div>
        <div class="glass rounded-xl p-4 card-hover">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 gradient-red rounded-lg flex items-center justify-center">‚ö†Ô∏è</div>
                <div>
                    <p class="text-2xl font-bold" id="kpi-clientes-divida">-</p>
                    <p class="text-slate-400 text-xs">Clientes c/ D√≠vida</p>
                </div>
            </div>
        </div>
        <div class="glass rounded-xl p-4 card-hover">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 gradient-blue rounded-lg flex items-center justify-center">üí∞</div>
                <div>
                    <p class="text-2xl font-bold" id="kpi-valor-divida">-</p>
                    <p class="text-slate-400 text-xs">Valor em D√≠vida</p>
                </div>
            </div>
        </div>
        <div class="glass rounded-xl p-4 card-hover">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 gradient-purple rounded-lg flex items-center justify-center">üë•</div>
                <div>
                    <p class="text-2xl font-bold" id="kpi-total-clientes">-</p>
                    <p class="text-slate-400 text-xs">Total Clientes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: Aprova√ß√µes -->
    <div id="content-aprovacoes" class="tab-content">
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Coluna Principal: Pedidos Pendentes -->
            <div class="lg:col-span-2 space-y-4" id="lista-aprovacoes">
                <div class="glass rounded-xl p-5 text-center">
                    <span class="spinner inline-block text-2xl">üîÑ</span>
                    <p class="text-slate-400 mt-2">A carregar facturas pendentes...</p>
                </div>
            </div>

            <!-- Coluna Lateral -->
            <div class="space-y-4">
                <!-- √öltimas Facturas -->
                <div class="glass rounded-xl p-5">
                    <h3 class="font-semibold mb-4">üìú √öltimas Facturas</h3>
                    <div class="space-y-3 text-sm max-h-96 overflow-y-auto" id="lista-ultimas-facturas">
                        <div class="text-center text-slate-500">A carregar...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: Alertas D√≠vida -->
    <div id="content-dividas" class="tab-content hidden">
        <div class="space-y-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">‚ö†Ô∏è Clientes com Facturas Pendentes</h2>
                <span class="badge bg-red-500/30 text-red-400">Dados Moloni</span>
            </div>
            <div id="lista-dividas" class="space-y-4">
                <div class="glass rounded-xl p-5 text-center">
                    <span class="spinner inline-block text-2xl">üîÑ</span>
                    <p class="text-slate-400 mt-2">A carregar alertas de d√≠vida...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: Hist√≥rico de Pre√ßos - CR√çTICO -->
    <div id="content-historico" class="tab-content hidden">
        <div class="glass rounded-xl p-6">
            <h2 class="text-xl font-bold mb-6">üìä Hist√≥rico de Pre√ßos por Cliente</h2>
            <p class="text-slate-400 mb-6">Seleccione um cliente para ver os produtos que j√° comprou e os pre√ßos praticados.</p>
            
            <div class="grid lg:grid-cols-2 gap-6">
                <!-- Selec√ß√£o de Cliente -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Cliente</label>
                        <select id="searchCliente" class="w-full rounded-lg px-4 py-3 text-white" onchange="carregarHistoricoCliente()">
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>
                    
                    <!-- Info do Cliente Seleccionado -->
                    <div id="info-cliente" class="glass-light rounded-xl p-4 hidden">
                        <h4 class="font-semibold mb-2" id="cliente-nome">-</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="text-slate-500">NIF:</span> <span id="cliente-nif">-</span></div>
                            <div><span class="text-slate-500">Email:</span> <span id="cliente-email">-</span></div>
                            <div><span class="text-slate-500">Telefone:</span> <span id="cliente-telefone">-</span></div>
                            <div><span class="text-slate-500">Total Facturas:</span> <span id="cliente-total-facturas">-</span></div>
                        </div>
                    </div>

                    <!-- Lista de Produtos Comprados pelo Cliente -->
                    <div id="produtos-cliente" class="hidden">
                        <label class="block text-sm text-slate-400 mb-2">Produtos Comprados por Este Cliente</label>
                        <div class="space-y-2 max-h-80 overflow-y-auto" id="lista-produtos-cliente">
                            <!-- Preenchido dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Hist√≥rico de Pre√ßos do Produto Seleccionado -->
                <div id="historico-precos" class="glass-light rounded-xl p-5">
                    <h3 class="font-semibold mb-4">üìã Seleccione um cliente para ver hist√≥rico</h3>
                    <div class="text-center text-slate-500 py-8">
                        <span class="text-4xl">üìä</span>
                        <p class="mt-2">O hist√≥rico de pre√ßos aparecer√° aqui</p>
                    </div>
                </div>
            </div>

            <!-- Compara√ß√£o de Pre√ßos -->
            <div id="comparacao-precos" class="mt-6 hidden">
                <h3 class="font-semibold mb-4">üí∞ Compara√ß√£o: √öltimo Pre√ßo vs Pre√ßo Actual</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-slate-400 border-b border-white/10">
                                <th class="text-left py-2">Produto</th>
                                <th class="text-right py-2">√öltimo Pre√ßo</th>
                                <th class="text-right py-2">Data</th>
                                <th class="text-right py-2">Pre√ßo Actual</th>
                                <th class="text-right py-2">Diferen√ßa</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-comparacao">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: Regras -->
    <div id="content-regras" class="tab-content hidden">
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">üìã Regras de Desconto & Pol√≠ticas</h2>
                <button onclick="guardarRegras()" class="gradient-green px-6 py-2 rounded-lg font-semibold transition-all hover:opacity-90">
                    üíæ Guardar Altera√ß√µes
                </button>
            </div>

            <div class="grid lg:grid-cols-2 gap-6">
                <!-- Regras de Desconto -->
                <div class="space-y-4">
                    <h3 class="font-semibold text-lg border-b border-white/10 pb-2">üí∞ Limites de Desconto</h3>
                    
                    <div class="glass-light rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="font-medium">Auto-Aprova√ß√£o (sem interven√ß√£o)</label>
                            <span class="badge bg-green-500/20 text-green-400">Activo</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-slate-400">At√©</span>
                            <input type="number" id="regra-auto" value="5" class="w-20 rounded-lg px-3 py-2 text-center text-white font-bold">
                            <span class="text-slate-400">% de desconto</span>
                        </div>
                    </div>

                    <div class="glass-light rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="font-medium">Aprova√ß√£o Paula (normal)</label>
                            <span class="badge bg-orange-500/20 text-orange-400">Requer Aprova√ß√£o</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-slate-400">De</span>
                            <input type="number" id="regra-paula-min" value="5" class="w-20 rounded-lg px-3 py-2 text-center text-white font-bold">
                            <span class="text-slate-400">a</span>
                            <input type="number" id="regra-paula-max" value="10" class="w-20 rounded-lg px-3 py-2 text-center text-white font-bold">
                            <span class="text-slate-400">%</span>
                        </div>
                    </div>

                    <div class="glass-light rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="font-medium">Desconto Excepcional</label>
                            <span class="badge bg-red-500/20 text-red-400">Justifica√ß√£o Obrigat√≥ria</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-slate-400">Acima de</span>
                            <input type="number" id="regra-excepcional" value="10" class="w-20 rounded-lg px-3 py-2 text-center text-white font-bold">
                            <span class="text-slate-400">%</span>
                        </div>
                    </div>
                </div>

                <!-- Pol√≠ticas de D√≠vida -->
                <div class="space-y-4">
                    <h3 class="font-semibold text-lg border-b border-white/10 pb-2">‚ö†Ô∏è Pol√≠ticas de D√≠vida</h3>
                    
                    <div class="glass-light rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="font-medium">Alerta de D√≠vida</label>
                            <span class="badge bg-yellow-500/20 text-yellow-400">Aviso ao Vendedor</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-slate-400">Quando cliente deve h√° mais de</span>
                            <input type="number" id="regra-divida-alerta" value="7" class="w-20 rounded-lg px-3 py-2 text-center text-white font-bold">
                            <span class="text-slate-400">dias</span>
                        </div>
                    </div>

                    <div class="glass-light rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="font-medium">Bloqueio Autom√°tico</label>
                            <span class="badge bg-red-500/20 text-red-400">Encomenda Bloqueada</span>
                        </div>
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-slate-400">Quando d√≠vida &gt;</span>
                            <input type="number" id="regra-bloqueio-valor" value="3000" class="w-24 rounded-lg px-3 py-2 text-center text-white font-bold">
                            <span class="text-slate-400">‚Ç¨</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-slate-400">OU vencida h√° mais de</span>
                            <input type="number" id="regra-bloqueio-dias" value="60" class="w-20 rounded-lg px-3 py-2 text-center text-white font-bold">
                            <span class="text-slate-400">dias</span>
                        </div>
                    </div>

                    <div class="glass-light rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="font-medium">Notifica√ß√µes</label>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="notif-desconto" checked class="rounded">
                                <label for="notif-desconto">Pedidos de desconto &gt; 5%</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="notif-divida" checked class="rounded">
                                <label for="notif-divida">Encomenda de cliente com d√≠vida</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="notif-venda" class="rounded">
                                <label for="notif-venda">Todas as vendas fechadas</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-4 right-4 glass rounded-xl p-4 shadow-2xl hidden notification-enter border-l-4" style="min-width: 300px;">
        <div class="flex items-center gap-3">
            <span id="toastIcon" class="text-2xl">‚úÖ</span>
            <div>
                <p id="toastTitle" class="font-semibold">Aprovado!</p>
                <p id="toastMessage" class="text-sm text-slate-400">Notifica√ß√£o enviada</p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // DADOS GLOBAIS
        // ==========================================
        let allCustomers = [];
        let allInvoices = [];
        let allProducts = [];
        let customerInvoices = {}; // Map customer_id -> invoices
        let productPrices = {}; // Map product_id -> { name, current_price }

        // ==========================================
        // API HELPERS
        // ==========================================
        async function fetchMoloni(endpoint) {
            try {
                const response = await fetch(`/api/moloni?endpoint=${encodeURIComponent(endpoint)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Erro ao buscar ${endpoint}:`, error);
                return null;
            }
        }

        // ==========================================
        // CARREGAR TODOS OS DADOS
        // ==========================================
        async function loadAllData() {
            showToast('üîÑ', 'A Carregar...', 'Buscando dados do Moloni', 'info');
            
            // Carregar em paralelo
            const [customers, invoices, products] = await Promise.all([
                fetchMoloni('customers/getAll'),
                fetchMoloni('invoices/getAll'),
                fetchMoloni('products/getAll')
            ]);

            if (customers) {
                allCustomers = customers;
                console.log(`‚úÖ ${customers.length} clientes carregados`);
            }
            
            if (invoices) {
                allInvoices = invoices;
                console.log(`‚úÖ ${invoices.length} facturas carregadas`);
                // Agrupar facturas por cliente
                customerInvoices = {};
                invoices.forEach(inv => {
                    const cid = inv.customer_id;
                    if (!customerInvoices[cid]) customerInvoices[cid] = [];
                    customerInvoices[cid].push(inv);
                });
            }
            
            if (products) {
                allProducts = products;
                console.log(`‚úÖ ${products.length} produtos carregados`);
                // Criar mapa de pre√ßos actuais
                productPrices = {};
                products.forEach(p => {
                    productPrices[p.product_id] = {
                        name: p.name,
                        reference: p.reference,
                        price: parseFloat(p.price) || 0,
                        unit: p.unit_name || 'un'
                    };
                });
            }

            // Actualizar UI
            updateKPIs();
            populateCustomerSelect();
            renderPendingInvoices();
            renderDebtAlerts();
            renderRecentInvoices();
            
            showToast('‚úÖ', 'Dados Carregados!', `${allCustomers.length} clientes, ${allInvoices.length} facturas`, 'success');
        }

        // ==========================================
        // KPIs
        // ==========================================
        function updateKPIs() {
            // Total clientes
            document.getElementById('kpi-total-clientes').textContent = allCustomers.length;
            
            // Facturas de hoje
            const today = new Date().toISOString().split('T')[0];
            const invoicesToday = allInvoices.filter(inv => inv.date && inv.date.startsWith(today));
            document.getElementById('kpi-aprovados-hoje').textContent = invoicesToday.length;
            
            // Facturas pendentes (status != closed/paid)
            const pendingInvoices = allInvoices.filter(inv => 
                inv.status === 0 || inv.status === 'draft' || inv.status === 'pending'
            );
            document.getElementById('kpi-pendentes').textContent = pendingInvoices.length;
            document.getElementById('badge-pendentes').textContent = pendingInvoices.length;
            
            // Clientes com d√≠vida e valor total
            const debtData = calculateDebtData();
            document.getElementById('kpi-clientes-divida').textContent = debtData.clientsWithDebt;
            document.getElementById('badge-dividas').textContent = debtData.clientsWithDebt;
            document.getElementById('kpi-valor-divida').textContent = formatCurrency(debtData.totalDebt);
        }

        function calculateDebtData() {
            const clientDebt = {};
            const today = new Date();
            
            allInvoices.forEach(inv => {
                // Considerar facturas n√£o pagas (verificar campo net_value ou similar)
                const isPaid = inv.status === 1 || inv.status === 'closed' || inv.status === 'paid';
                if (isPaid) return;
                
                const dueDate = inv.expiration_date ? new Date(inv.expiration_date) : null;
                if (dueDate && dueDate < today) {
                    const cid = inv.customer_id;
                    if (!clientDebt[cid]) clientDebt[cid] = 0;
                    clientDebt[cid] += parseFloat(inv.net_value) || 0;
                }
            });
            
            const clientsWithDebt = Object.keys(clientDebt).length;
            const totalDebt = Object.values(clientDebt).reduce((sum, v) => sum + v, 0);
            
            return { clientsWithDebt, totalDebt, clientDebt };
        }

        // ==========================================
        // APROVA√á√ïES (Facturas Pendentes/Draft)
        // ==========================================
        function renderPendingInvoices() {
            const container = document.getElementById('lista-aprovacoes');
            
            // Filtrar facturas pendentes (status 0 = draft no Moloni)
            const pending = allInvoices.filter(inv => 
                inv.status === 0 || inv.status === 'draft'
            ).slice(0, 20); // Limitar a 20
            
            if (pending.length === 0) {
                container.innerHTML = `
                    <div class="glass rounded-xl p-5 text-center">
                        <span class="text-4xl">‚úÖ</span>
                        <p class="text-slate-400 mt-2">N√£o h√° facturas pendentes de aprova√ß√£o</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pending.map(inv => {
                const customer = allCustomers.find(c => c.customer_id === inv.customer_id) || {};
                const value = parseFloat(inv.net_value) || 0;
                const date = inv.date ? new Date(inv.date).toLocaleDateString('pt-PT') : '-';
                
                return `
                    <div class="glass rounded-xl p-5 card-hover border-l-4 border-orange-500" data-invoice-id="${inv.document_id}">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="badge bg-orange-500/20 text-orange-400">üìÑ FACTURA DRAFT</span>
                                    <span class="text-xs text-slate-500">${date}</span>
                                </div>
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-lg">üè™</div>
                                    <div>
                                        <p class="font-semibold">${customer.name || 'Cliente #' + inv.customer_id}</p>
                                        <p class="text-sm text-slate-400">NIF: ${customer.vat || '-'}</p>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-4 text-sm">
                                    <div><span class="text-slate-500">Doc:</span> <span class="font-medium">${inv.document_set_name || ''} ${inv.number || ''}</span></div>
                                    <div><span class="text-slate-500">Valor:</span> <span class="font-semibold text-green-400">${formatCurrency(value)}</span></div>
                                </div>
                            </div>
                            <div class="flex lg:flex-col gap-2">
                                <button onclick="aprovarFactura('${inv.document_id}')" class="btn-approve px-5 py-2 rounded-lg font-semibold transition-all text-sm">‚úÖ Aprovar</button>
                                <button onclick="verDetalhes('${inv.document_id}')" class="glass hover:bg-white/10 px-5 py-2 rounded-lg font-semibold transition-all text-sm">üëÅÔ∏è Ver</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // ALERTAS DE D√çVIDA
        // ==========================================
        function renderDebtAlerts() {
            const container = document.getElementById('lista-dividas');
            const debtData = calculateDebtData();
            const today = new Date();
            
            // Criar lista de clientes com d√≠vida
            const debtClients = [];
            Object.entries(debtData.clientDebt).forEach(([cid, totalDebt]) => {
                const customer = allCustomers.find(c => c.customer_id == cid) || {};
                const customerInvs = customerInvoices[cid] || [];
                
                // Encontrar factura mais antiga vencida
                let oldestDueDate = null;
                let pendingCount = 0;
                customerInvs.forEach(inv => {
                    const isPaid = inv.status === 1 || inv.status === 'closed' || inv.status === 'paid';
                    if (isPaid) return;
                    
                    const dueDate = inv.expiration_date ? new Date(inv.expiration_date) : null;
                    if (dueDate && dueDate < today) {
                        pendingCount++;
                        if (!oldestDueDate || dueDate < oldestDueDate) {
                            oldestDueDate = dueDate;
                        }
                    }
                });
                
                if (totalDebt > 0) {
                    const daysPast = oldestDueDate ? Math.floor((today - oldestDueDate) / (1000 * 60 * 60 * 24)) : 0;
                    debtClients.push({
                        customer,
                        totalDebt,
                        pendingCount,
                        daysPast,
                        oldestDueDate
                    });
                }
            });
            
            // Ordenar por valor de d√≠vida (maior primeiro)
            debtClients.sort((a, b) => b.totalDebt - a.totalDebt);
            
            if (debtClients.length === 0) {
                container.innerHTML = `
                    <div class="glass rounded-xl p-5 text-center">
                        <span class="text-4xl">‚úÖ</span>
                        <p class="text-slate-400 mt-2">N√£o h√° clientes com d√≠vidas vencidas</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = debtClients.slice(0, 15).map(item => {
                const urgency = item.daysPast > 30 ? 'red' : item.daysPast > 14 ? 'orange' : 'yellow';
                const urgencyLabel = item.daysPast > 30 ? 'üö® URGENTE' : item.daysPast > 14 ? '‚ö†Ô∏è ATEN√á√ÉO' : 'üìã PENDENTE';
                
                return `
                    <div class="glass rounded-xl p-5 border-l-4 border-${urgency}-500 ${item.daysPast > 30 ? 'pulse-urgent' : ''}">
                        <div class="flex flex-col lg:flex-row lg:items-start justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="badge bg-${urgency}-500/30 text-${urgency}-400">${urgencyLabel}</span>
                                </div>
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 rounded-full bg-${urgency}-500/20 flex items-center justify-center text-xl">üè™</div>
                                    <div>
                                        <p class="font-semibold text-lg">${item.customer.name || 'Cliente Desconhecido'}</p>
                                        <p class="text-sm text-slate-400">NIF: ${item.customer.vat || '-'}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div class="glass-light rounded-lg p-3 text-center">
                                        <p class="text-2xl font-bold text-${urgency}-400">${formatCurrency(item.totalDebt)}</p>
                                        <p class="text-xs text-slate-500">D√≠vida Total</p>
                                    </div>
                                    <div class="glass-light rounded-lg p-3 text-center">
                                        <p class="text-2xl font-bold text-${urgency}-400">${item.daysPast} dias</p>
                                        <p class="text-xs text-slate-500">Mais Antiga</p>
                                    </div>
                                    <div class="glass-light rounded-lg p-3 text-center">
                                        <p class="text-2xl font-bold text-yellow-400">${item.pendingCount}</p>
                                        <p class="text-xs text-slate-500">Facturas Pendentes</p>
                                    </div>
                                    <div class="glass-light rounded-lg p-3 text-center">
                                        <p class="text-2xl font-bold text-blue-400">${item.customer.phone || '-'}</p>
                                        <p class="text-xs text-slate-500">Telefone</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="enviarLembrete('${item.customer.customer_id}')" class="btn-counter px-6 py-3 rounded-lg font-semibold transition-all">
                                    üìß Enviar Lembrete
                                </button>
                                <button onclick="verHistoricoCliente('${item.customer.customer_id}')" class="glass hover:bg-white/10 px-6 py-3 rounded-lg font-semibold transition-all">
                                    üìä Ver Hist√≥rico
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // HIST√ìRICO DE PRE√áOS - CR√çTICO
        // ==========================================
        function populateCustomerSelect() {
            const select = document.getElementById('searchCliente');
            select.innerHTML = '<option value="">Seleccionar cliente...</option>';
            
            // Ordenar clientes por nome
            const sorted = [...allCustomers].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            
            sorted.forEach(c => {
                const option = document.createElement('option');
                option.value = c.customer_id;
                option.textContent = c.name || `Cliente #${c.customer_id}`;
                select.appendChild(option);
            });
        }

        function carregarHistoricoCliente() {
            const customerId = document.getElementById('searchCliente').value;
            if (!customerId) {
                document.getElementById('info-cliente').classList.add('hidden');
                document.getElementById('produtos-cliente').classList.add('hidden');
                document.getElementById('comparacao-precos').classList.add('hidden');
                document.getElementById('historico-precos').innerHTML = `
                    <h3 class="font-semibold mb-4">üìã Seleccione um cliente para ver hist√≥rico</h3>
                    <div class="text-center text-slate-500 py-8">
                        <span class="text-4xl">üìä</span>
                        <p class="mt-2">O hist√≥rico de pre√ßos aparecer√° aqui</p>
                    </div>
                `;
                return;
            }
            
            const customer = allCustomers.find(c => c.customer_id == customerId);
            const invoices = customerInvoices[customerId] || [];
            
            // Mostrar info do cliente
            document.getElementById('info-cliente').classList.remove('hidden');
            document.getElementById('cliente-nome').textContent = customer?.name || '-';
            document.getElementById('cliente-nif').textContent = customer?.vat || '-';
            document.getElementById('cliente-email').textContent = customer?.email || '-';
            document.getElementById('cliente-telefone').textContent = customer?.phone || '-';
            document.getElementById('cliente-total-facturas').textContent = invoices.length;
            
            // Extrair produtos comprados e seus pre√ßos
            const productHistory = {}; // product_id -> [{date, price, qty, invoice}]
            
            invoices.forEach(inv => {
                const products = inv.products || [];
                products.forEach(p => {
                    const pid = p.product_id;
                    if (!productHistory[pid]) {
                        productHistory[pid] = {
                            name: p.name || productPrices[pid]?.name || `Produto #${pid}`,
                            reference: p.reference || productPrices[pid]?.reference || '',
                            currentPrice: productPrices[pid]?.price || 0,
                            unit: productPrices[pid]?.unit || 'un',
                            history: []
                        };
                    }
                    productHistory[pid].history.push({
                        date: inv.date,
                        price: parseFloat(p.price) || 0,
                        qty: parseFloat(p.qty) || 0,
                        discount: parseFloat(p.discount) || 0,
                        invoiceNumber: `${inv.document_set_name || ''} ${inv.number || ''}`
                    });
                });
            });
            
            // Ordenar hist√≥rico de cada produto por data (mais recente primeiro)
            Object.values(productHistory).forEach(p => {
                p.history.sort((a, b) => new Date(b.date) - new Date(a.date));
            });
            
            // Mostrar lista de produtos
            document.getElementById('produtos-cliente').classList.remove('hidden');
            const listaContainer = document.getElementById('lista-produtos-cliente');
            
            const productList = Object.entries(productHistory);
            if (productList.length === 0) {
                listaContainer.innerHTML = `<p class="text-slate-500 text-center py-4">Nenhum produto encontrado nas facturas</p>`;
                return;
            }
            
            listaContainer.innerHTML = productList.map(([pid, data]) => {
                const lastPrice = data.history[0]?.price || 0;
                const lastDate = data.history[0]?.date ? new Date(data.history[0].date).toLocaleDateString('pt-PT') : '-';
                const diff = data.currentPrice > 0 ? ((lastPrice - data.currentPrice) / data.currentPrice * 100).toFixed(1) : 0;
                const diffClass = diff > 0 ? 'text-red-400' : diff < 0 ? 'text-green-400' : 'text-slate-400';
                const diffSign = diff > 0 ? '+' : '';
                
                return `
                    <div class="glass-light rounded-lg p-3 cursor-pointer hover:bg-white/10 transition-all" onclick="mostrarHistoricoProduto('${pid}')">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium">${data.name}</p>
                                <p class="text-xs text-slate-500">${data.reference} ‚Ä¢ ${data.history.length} compras</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold">${formatCurrency(lastPrice)}/${data.unit}</p>
                                <p class="text-xs ${diffClass}">${diffSign}${diff}% vs tabela</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Mostrar tabela de compara√ß√£o
            renderComparisonTable(productHistory);
            
            // Mostrar primeiro produto automaticamente
            if (productList.length > 0) {
                mostrarHistoricoProduto(productList[0][0]);
            }
        }

        function mostrarHistoricoProduto(productId) {
            const customerId = document.getElementById('searchCliente').value;
            const invoices = customerInvoices[customerId] || [];
            
            // Reconstruir hist√≥rico para este produto
            const history = [];
            invoices.forEach(inv => {
                const products = inv.products || [];
                products.forEach(p => {
                    if (p.product_id == productId) {
                        history.push({
                            date: inv.date,
                            price: parseFloat(p.price) || 0,
                            qty: parseFloat(p.qty) || 0,
                            discount: parseFloat(p.discount) || 0,
                            invoiceNumber: `${inv.document_set_name || ''} ${inv.number || ''}`
                        });
                    }
                });
            });
            
            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const productInfo = productPrices[productId] || { name: `Produto #${productId}`, price: 0, unit: 'un' };
            const customer = allCustomers.find(c => c.customer_id == customerId);
            
            // Calcular estat√≠sticas
            const prices = history.map(h => h.price);
            const avgPrice = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : 0;
            const totalQty = history.reduce((sum, h) => sum + h.qty, 0);
            const totalValue = history.reduce((sum, h) => sum + (h.price * h.qty), 0);
            
            const container = document.getElementById('historico-precos');
            container.innerHTML = `
                <h3 class="font-semibold mb-4">üìã ${productInfo.name} ‚Üí ${customer?.name || 'Cliente'}</h3>
                <div class="space-y-3 max-h-64 overflow-y-auto">
                    ${history.map(h => {
                        const date = h.date ? new Date(h.date).toLocaleDateString('pt-PT') : '-';
                        const diff = productInfo.price > 0 ? ((h.price - productInfo.price) / productInfo.price * 100).toFixed(1) : 0;
                        const diffClass = diff > 0 ? 'text-red-400' : diff < 0 ? 'text-green-400' : 'text-slate-400';
                        
                        return `
                            <div class="flex items-center justify-between p-3 rounded-lg bg-white/5">
                                <div>
                                    <p class="font-medium">${date}</p>
                                    <p class="text-xs text-slate-500">${h.qty} ${productInfo.unit} ‚Ä¢ ${h.invoiceNumber}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold ${diffClass}">${formatCurrency(h.price)}/${productInfo.unit}</p>
                                    <p class="text-xs text-slate-500">${diff > 0 ? '+' : ''}${diff}% vs tabela</p>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="mt-4 pt-4 border-t border-white/10">
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <p class="text-slate-400">Pre√ßo M√©dio</p>
                            <p class="font-bold text-lg">${formatCurrency(avgPrice)}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-slate-400">Total Comprado</p>
                            <p class="font-bold text-lg">${totalQty.toFixed(0)} ${productInfo.unit}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-slate-400">Valor Total</p>
                            <p class="font-bold text-lg text-green-400">${formatCurrency(totalValue)}</p>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <p class="text-slate-400 text-sm">Pre√ßo Tabela Actual: <span class="font-bold text-blue-400">${formatCurrency(productInfo.price)}/${productInfo.unit}</span></p>
                    </div>
                </div>
            `;
        }

        function renderComparisonTable(productHistory) {
            const container = document.getElementById('comparacao-precos');
            const tbody = document.getElementById('tabela-comparacao');
            
            const rows = Object.entries(productHistory).map(([pid, data]) => {
                const lastPrice = data.history[0]?.price || 0;
                const lastDate = data.history[0]?.date ? new Date(data.history[0].date).toLocaleDateString('pt-PT') : '-';
                const diff = data.currentPrice > 0 ? lastPrice - data.currentPrice : 0;
                const diffPercent = data.currentPrice > 0 ? (diff / data.currentPrice * 100).toFixed(1) : 0;
                const diffClass = diff > 0 ? 'text-red-400' : diff < 0 ? 'text-green-400' : 'text-slate-400';
                
                return `
                    <tr class="border-b border-white/5 hover:bg-white/5 cursor-pointer" onclick="mostrarHistoricoProduto('${pid}')">
                        <td class="py-2">${data.name}</td>
                        <td class="text-right font-semibold">${formatCurrency(lastPrice)}</td>
                        <td class="text-right text-slate-400">${lastDate}</td>
                        <td class="text-right font-semibold text-blue-400">${formatCurrency(data.currentPrice)}</td>
                        <td class="text-right ${diffClass}">${diff > 0 ? '+' : ''}${formatCurrency(diff)} (${diffPercent}%)</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
            container.classList.remove('hidden');
        }

        // ==========================================
        // √öLTIMAS FACTURAS
        // ==========================================
        function renderRecentInvoices() {
            const container = document.getElementById('lista-ultimas-facturas');
            
            // Ordenar por data (mais recentes primeiro)
            const sorted = [...allInvoices]
                .filter(inv => inv.date)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            if (sorted.length === 0) {
                container.innerHTML = `<p class="text-slate-500 text-center">Nenhuma factura encontrada</p>`;
                return;
            }
            
            container.innerHTML = sorted.map(inv => {
                const customer = allCustomers.find(c => c.customer_id === inv.customer_id) || {};
                const value = parseFloat(inv.net_value) || 0;
                const date = inv.date ? new Date(inv.date).toLocaleDateString('pt-PT') : '-';
                const isPaid = inv.status === 1 || inv.status === 'closed' || inv.status === 'paid';
                
                return `
                    <div class="flex items-center gap-3 p-2 rounded-lg glass-light">
                        <span class="${isPaid ? 'text-green-400' : 'text-orange-400'}">${isPaid ? '‚úÖ' : '‚è≥'}</span>
                        <div class="flex-1 min-w-0">
                            <p class="text-slate-300 truncate">${customer.name || 'Cliente'}</p>
                            <p class="text-xs text-slate-500">${date}</p>
                        </div>
                        <span class="font-semibold text-green-400">${formatCurrency(value)}</span>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // ACTIONS
        // ==========================================
        function aprovarFactura(invoiceId) {
            showToast('‚úÖ', 'Factura Aprovada!', 'Notifica√ß√£o enviada', 'success');
            const card = document.querySelector(`[data-invoice-id="${invoiceId}"]`);
            if (card) {
                card.style.opacity = '0.5';
                card.style.transform = 'translateX(100px)';
                card.style.transition = 'all 0.3s ease';
                setTimeout(() => card.remove(), 300);
            }
        }

        function verDetalhes(invoiceId) {
            const inv = allInvoices.find(i => i.document_id == invoiceId);
            if (inv) {
                console.log('Detalhes:', inv);
                showToast('üìÑ', 'Detalhes', JSON.stringify(inv.products || [], null, 2).substring(0, 100), 'info');
            }
        }

        function enviarLembrete(customerId) {
            const customer = allCustomers.find(c => c.customer_id == customerId);
            showToast('üìß', 'Lembrete Enviado!', `Email enviado para ${customer?.email || 'cliente'}`, 'info');
        }

        function verHistoricoCliente(customerId) {
            document.getElementById('searchCliente').value = customerId;
            showTab('historico');
            carregarHistoricoCliente();
        }

        // ==========================================
        // UI HELPERS
        // ==========================================
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('tab-active'));
            document.getElementById('content-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('tab-active');
        }

        function showToast(icon, title, message, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = icon;
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            
            toast.classList.remove('hidden', 'border-green-500', 'border-red-500', 'border-orange-500', 'border-blue-500');
            const colors = { success: 'border-green-500', reject: 'border-red-500', counter: 'border-orange-500', info: 'border-blue-500' };
            toast.classList.add(colors[type] || 'border-green-500');
            
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR' }).format(value || 0);
        }

        function refreshAllData() {
            loadAllData();
        }

        // Regras
        function guardarRegras() {
            const regras = {
                autoAprovacao: document.getElementById('regra-auto').value,
                paulaMin: document.getElementById('regra-paula-min').value,
                paulaMax: document.getElementById('regra-paula-max').value,
                excepcional: document.getElementById('regra-excepcional').value,
                dividaAlerta: document.getElementById('regra-divida-alerta').value,
                bloqueioValor: document.getElementById('regra-bloqueio-valor').value,
                bloqueioDias: document.getElementById('regra-bloqueio-dias').value
            };
            localStorage.setItem('auroraRegras', JSON.stringify(regras));
            showToast('üíæ', 'Regras Guardadas!', 'As altera√ß√µes foram aplicadas', 'success');
        }

        // ==========================================
        // INIT
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved rules
            const saved = localStorage.getItem('auroraRegras');
            if (saved) {
                const regras = JSON.parse(saved);
                Object.entries(regras).forEach(([key, value]) => {
                    const el = document.getElementById('regra-' + key.replace(/([A-Z])/g, '-$1').toLowerCase());
                    if (el) el.value = value;
                });
            }
            
            // Carregar dados do Moloni
            loadAllData();
        });
    </script>
</body>
</html>
